<%- include('partials/header', { 
    pageTitle: typeof t !== 'undefined' ? t('game.title', { gameName: gameName }) : (pageTitle || (gameName + ' - Ice Breaker Games')),
    metaDescription: typeof t !== 'undefined' ? t('game.description', { gameName: gameName, categoryName: gameCategory || '' }) : (gameDescription || ('ç© ' + gameName + ' - å…è´¹åœ¨çº¿HTML5æ¸¸æˆ')),
    metaKeywords: gameKeywords || (gameName + ', ice breaker games'),
    canonicalUrl: typeof localeUrl !== 'undefined' ? localeUrl('/game?name=' + encodeURIComponent(gameName)) : (canonicalUrl || ('https://www.icebreakgame.com/game?name=' + encodeURIComponent(gameName))),
    searchQuery: ''
}) %>

<!-- ä¸»å†…å®¹åŒº -->
<div class="main-content">
    <!-- å†…å®¹åŒºï¼ˆå…¨å®½æ˜¾ç¤ºï¼‰ -->
    <div class="content-area" style="width: 100%;">
        <!-- æ¸¸æˆæ§åˆ¶æ  -->
        <div class="game-control-bar">
            <div class="game-control-left">
                <h1 class="game-detail-title-inline"><%- game.name %></h1>
                <% if (gameCategory) { %>
                    <div class="game-detail-category-inline">
                        <span class="nav-icon"><%= getCategoryIcon(gameCategory) %></span>
                        <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '')) : '/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '') %>" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">
                            <%= gameCategory %>
                        </a>
                    </div>
                <% } %>
            </div>
            <div class="game-control-right">
                <% if (gameCategory) { %>
                    <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '')) : '/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '') %>" class="game-control-btn">
                        â† <%= typeof t !== 'undefined' ? t('game.backToCategory') : 'è¿”å›åˆ†ç±»' %>
                    </a>
                <% } %>
                <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/') : '/' %>" class="game-control-btn">
                    â† <%= typeof t !== 'undefined' ? t('game.backToHome') : 'è¿”å›é¦–é¡µ' %>
                </a>
                <button id="fullscreenBtn" class="game-control-btn fullscreen-btn">
                    â›¶ <%= typeof t !== 'undefined' ? t('game.fullscreen') : 'å…¨å±' %>
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆiframeå®¹å™¨ -->
        <div class="game-iframe-container" id="gameContainer">
            <% if (game.link) { %>
                <iframe 
                    id="gameIframe" 
                    src="<%= game.link %>" 
                    frameborder="0" 
                    allowfullscreen
                    style="width: 100%; height: 100%; border: none;">
                </iframe>
            <% } else { %>
                <div class="game-iframe-placeholder">
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <h2 style="margin-bottom: 1rem; font-size: 2rem;">ğŸ®</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;"><%= typeof t !== 'undefined' ? t('game.noLink') : 'è¯¥æ¸¸æˆæš‚æ— é“¾æ¥' %></p>
                        <p style="font-size: 0.9rem;">
                            <% if (game.href) { %>
                                <a href="<%= game.href %>" target="_blank" style="color: rgba(102, 126, 234, 0.9); text-decoration: underline;">
                                    <%= typeof t !== 'undefined' ? t('game.viewDetailPage') : 'æŸ¥çœ‹æ¸¸æˆè¯¦æƒ…é¡µ' %>
                                </a>
                            <% } %>
                        </p>
                    </div>
                </div>
            <% } %>
        </div>
        
        <!-- æ¸¸æˆè¯¦æƒ…ä¿¡æ¯ -->
        <div class="game-detail-section">

            <!-- æ¸¸æˆå¤´éƒ¨ä¿¡æ¯ï¼ˆæŠ˜å æ˜¾ç¤ºï¼‰ -->
            <div class="game-info-header">
                <div class="game-info-header-content">
                    <% if (game.icon) { %>
                        <img src="<%= game.icon %>" alt="<%= game.name %>" class="game-info-image" onerror="this.style.display='none';">
                    <% } %>
                    <div class="game-info-text">
                        <h2 class="game-info-title"><%- game.name %></h2>
                        <% if (gameCategory) { %>
                            <div class="game-info-category">
                                <span class="nav-icon"><%= getCategoryIcon(gameCategory) %></span>
                                <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '')) : '/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '') %>" style="color: rgba(102, 126, 234, 0.9); text-decoration: none;">
                                    <%= gameCategory %>
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆæè¿° -->
            <% if (game.detail) { %>
                <div class="game-detail-content">
                    <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.gameIntroduction') : 'æ¸¸æˆä»‹ç»' %></h2>
                    <div id="game-detail-text" class="game-detail-text" data-game-id="<%= typeof gameId !== 'undefined' ? gameId : game.id %>" data-category-id="<%= typeof categoryId !== 'undefined' ? categoryId : '' %>" data-locale="<%= typeof locale !== 'undefined' ? locale : 'zh-CN' %>">
                        <% 
                            // æ ¼å¼åŒ–æè¿°æ–‡æœ¬ï¼Œå°†æ¢è¡Œè½¬æ¢ä¸ºæ®µè½
                            const detailLines = game.detail.split('\n').filter(line => line.trim());
                            let inParagraph = false;
                            let skipNext = false;
                            
                            detailLines.forEach((line, index) => {
                                const trimmedLine = line.trim();
                                
                                // è·³è¿‡ä¸€äº›å…ƒæ•°æ®è¡Œå’Œåˆ†éš”ç¬¦
                                if (trimmedLine.includes('GamesÂ»') || 
                                    trimmedLine === 'Share' ||
                                    trimmedLine.includes('Developer') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Rating') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Released') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Technology') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Platform') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Wiki pages') ||
                                    trimmedLine.match(/^[0-9]+$/) ||  // çº¯æ•°å­—
                                    trimmedLine.length < 5) {
                                    return;
                                }
                                
                                // å¦‚æœæ˜¯æ ‡é¢˜è¡Œï¼ˆçŸ­ä¸”å¯èƒ½æ˜¯æ ‡é¢˜ï¼Œä¸”æ²¡æœ‰æ ‡ç‚¹ç¬¦å·ï¼‰
                                if (trimmedLine.length < 60 && 
                                    !trimmedLine.includes('.') && 
                                    !trimmedLine.includes(',') &&
                                    !trimmedLine.includes('?') &&
                                    !trimmedLine.includes('!') &&
                                    trimmedLine.length > 10 &&
                                    index < 15) {
                                    if (inParagraph) {
                                        inParagraph = false;
                                        %>
                                        </p>
                                        <%
                                    }
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§çš„æ ‡é¢˜æ ¼å¼
                                    if (trimmedLine.match(/^[A-Z][a-z]+ [A-Z][a-z]+/) || 
                                        trimmedLine.match(/^[A-Z][a-z]+ [a-z]+ [A-Z]/) ||
                                        trimmedLine.includes('How to') ||
                                        trimmedLine.includes('Features') ||
                                        trimmedLine.includes('Controls') ||
                                        trimmedLine.includes('FAQ')) {
                                        %>
                                        <h3 class="game-detail-subtitle"><%= trimmedLine %></h3>
                                        <%
                                    }
                                    return;
                                }
                                
                                // å¦‚æœæ˜¯æ®µè½å†…å®¹ï¼ˆé•¿åº¦åˆç†ä¸”æœ‰æ„ä¹‰çš„æ–‡æœ¬ï¼‰
                                if (trimmedLine.length > 15) {
                                    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼ˆé™¤äº†æˆ‘ä»¬å…è®¸çš„æ ¼å¼ï¼‰
                                    const escapedLine = trimmedLine
                                        .replace(/&/g, '&amp;')
                                        .replace(/</g, '&lt;')
                                        .replace(/>/g, '&gt;')
                                        .replace(/&lt;strong&gt;/g, '<strong>')
                                        .replace(/&lt;\/strong&gt;/g, '</strong>');
                                    
                                    if (!inParagraph) {
                                        inParagraph = true;
                                        %>
                                        <p>
                                        <%
                                    } else {
                                        %>
                                        <br><br>
                                        <%
                                    }
                                    %>
                                    <%- escapedLine %>
                                    <%
                                }
                            });
                            if (inParagraph) {
                                %>
                                </p>
                                <%
                            }
                        %>
                    </div>
                </div>
            <% } %>

            <!-- æ¸¸æˆç‰¹æ€§ -->
            <div class="game-features">
                <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.gameFeatures') : 'æ¸¸æˆç‰¹æ€§' %></h2>
                <ul class="game-features-list">
                    <li>âœ… <%= typeof t !== 'undefined' ? t('game.features.free') : 'å…è´¹åœ¨çº¿æ¸¸æˆï¼Œæ— éœ€ä¸‹è½½' %></li>
                    <li>âœ… <%= typeof t !== 'undefined' ? t('game.features.crossPlatform') : 'æ”¯æŒPCå’Œç§»åŠ¨ç«¯' %></li>
                    <li>âœ… <%= typeof t !== 'undefined' ? t('game.features.html5') : 'HTML5æŠ€æœ¯ï¼Œå³å¼€å³ç©' %></li>
                    <% if (gameCategory) { %>
                        <li>âœ… <%= typeof t !== 'undefined' ? t('game.features.category', { category: gameCategory }) : ('å±äº' + gameCategory + 'åˆ†ç±»') %></li>
                    <% } %>
                </ul>
            </div>

            <!-- ç›¸å…³æ¸¸æˆæ¨è -->
            <% if (gameCategory) { %>
                <div class="game-related">
                    <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.relatedGames') : 'ç›¸å…³æ¸¸æˆæ¨è' %></h2>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '')) : '/category?categoryId=' + (typeof categoryId !== 'undefined' ? categoryId : '') %>" class="more-btn">
                            <%= typeof t !== 'undefined' ? t('game.viewAllInCategory', { category: gameCategory }) : ('æŸ¥çœ‹ ' + gameCategory + ' åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ¸¸æˆ â†’') %>
                        </a>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // å…¨å±åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const gameContainer = document.getElementById('gameContainer');
        const gameIframe = document.getElementById('gameIframe');
        
        if (!fullscreenBtn || !gameContainer) return;
        
        const fullscreenText = '<%= typeof t !== "undefined" ? t("game.fullscreen") : "å…¨å±" %>';
        const exitFullscreenText = '<%= typeof t !== "undefined" ? t("game.exitFullscreen") : "é€€å‡ºå…¨å±" %>';
        
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // è¿›å…¥å…¨å±
                if (gameContainer.requestFullscreen) {
                    gameContainer.requestFullscreen();
                } else if (gameContainer.webkitRequestFullscreen) {
                    gameContainer.webkitRequestFullscreen();
                } else if (gameContainer.mozRequestFullScreen) {
                    gameContainer.mozRequestFullScreen();
                } else if (gameContainer.msRequestFullscreen) {
                    gameContainer.msRequestFullscreen();
                }
            } else {
                // é€€å‡ºå…¨å±
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
        function handleFullscreenChange() {
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                fullscreenBtn.textContent = 'âŒ ' + exitFullscreenText;
                fullscreenBtn.classList.add('active');
            } else {
                fullscreenBtn.textContent = 'â›¶ ' + fullscreenText;
                fullscreenBtn.classList.remove('active');
            }
        }
        
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        // é”®ç›˜å¿«æ·é”®ï¼šF11 å…¨å±ï¼ŒESC é€€å‡ºï¼ˆæµè§ˆå™¨é»˜è®¤å¤„ç†ï¼‰
    });
</script>

<%- include('partials/footer') %>
