<%- include('partials/header', { 
    pageTitle: typeof t !== 'undefined' ? t('game.title', { gameName: gameName }) : (pageTitle || (gameName + ' - Ice Breaker Games')),
    metaDescription: typeof t !== 'undefined' ? t('game.description', { gameName: gameName, categoryName: gameCategory || '' }) : (gameDescription || ('Áé© ' + gameName + ' - ÂÖçË¥πÂú®Á∫øHTML5Ê∏∏Êàè')),
    metaKeywords: gameKeywords || (gameName + ', ice breaker games'),
    canonicalUrl: typeof localeUrl !== 'undefined' ? localeUrl('/game?name=' + encodeURIComponent(gameName)) : (canonicalUrl || ('https://www.icebreakgame.com/game?name=' + encodeURIComponent(gameName))),
    searchQuery: ''
}) %>

<!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
<div class="main-content">
    <!-- ÂÜÖÂÆπÂå∫ÔºàÂÖ®ÂÆΩÊòæÁ§∫Ôºâ -->
    <div class="content-area" style="width: 100%;">
        <!-- Ê∏∏ÊàèÊéßÂà∂Ê†è -->
        <div class="game-control-bar">
            <div class="game-control-left">
                <h1 class="game-detail-title-inline"><%- game.name %></h1>
                <% if (gameCategory) { %>
                    <div class="game-detail-category-inline">
                        <span class="nav-icon"><%= getCategoryIcon(gameCategory) %></span>
                        <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory)) : '/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory) %>" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">
                            <%= gameCategory %>
                        </a>
                    </div>
                <% } %>
            </div>
            <div class="game-control-right">
                <% if (gameCategory) { %>
                    <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory)) : '/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory) %>" class="game-control-btn">
                        ‚Üê <%= typeof t !== 'undefined' ? t('game.backToCategory') : 'ËøîÂõûÂàÜÁ±ª' %>
                    </a>
                <% } %>
                <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/') : '/' %>" class="game-control-btn">
                    ‚Üê <%= typeof t !== 'undefined' ? t('game.backToHome') : 'ËøîÂõûÈ¶ñÈ°µ' %>
                </a>
                <button id="fullscreenBtn" class="game-control-btn fullscreen-btn">
                    ‚õ∂ <%= typeof t !== 'undefined' ? t('game.fullscreen') : 'ÂÖ®Â±è' %>
                </button>
            </div>
        </div>

        <!-- Ê∏∏ÊàèiframeÂÆπÂô® -->
        <div class="game-iframe-container" id="gameContainer">
            <% if (game.link) { %>
                <iframe 
                    id="gameIframe" 
                    src="<%= game.link %>" 
                    frameborder="0" 
                    allowfullscreen
                    style="width: 100%; height: 100%; border: none;">
                </iframe>
            <% } else { %>
                <div class="game-iframe-placeholder">
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <h2 style="margin-bottom: 1rem; font-size: 2rem;">üéÆ</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;"><%= typeof t !== 'undefined' ? t('game.noLink') : 'ËØ•Ê∏∏ÊàèÊöÇÊó†ÈìæÊé•' %></p>
                        <p style="font-size: 0.9rem;">
                            <% if (game.href) { %>
                                <a href="<%= game.href %>" target="_blank" style="color: rgba(102, 126, 234, 0.9); text-decoration: underline;">
                                    <%= typeof t !== 'undefined' ? t('game.viewDetailPage') : 'Êü•ÁúãÊ∏∏ÊàèËØ¶ÊÉÖÈ°µ' %>
                                </a>
                            <% } %>
                        </p>
                    </div>
                </div>
            <% } %>
        </div>
        
        <!-- Ê∏∏ÊàèËØ¶ÊÉÖ‰ø°ÊÅØ -->
        <div class="game-detail-section">

            <!-- Ê∏∏ÊàèÂ§¥ÈÉ®‰ø°ÊÅØÔºàÊäòÂè†ÊòæÁ§∫Ôºâ -->
            <div class="game-info-header">
                <div class="game-info-header-content">
                    <% if (game.icon) { %>
                        <img src="<%= game.icon %>" alt="<%= game.name %>" class="game-info-image" onerror="this.style.display='none';">
                    <% } %>
                    <div class="game-info-text">
                        <h2 class="game-info-title"><%- game.name %></h2>
                        <% if (gameCategory) { %>
                            <div class="game-info-category">
                                <span class="nav-icon"><%= getCategoryIcon(gameCategory) %></span>
                                <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory)) : '/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory) %>" style="color: rgba(102, 126, 234, 0.9); text-decoration: none;">
                                    <%= gameCategory %>
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Ê∏∏ÊàèÊèèËø∞ -->
            <% if (game.detail) { %>
                <div class="game-detail-content">
                    <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.gameIntroduction') : 'Ê∏∏Êàè‰ªãÁªç' %></h2>
                    <div id="game-detail-text" class="game-detail-text" data-game-id="<%= typeof gameId !== 'undefined' ? gameId : game.id %>" data-category-id="<%= typeof categoryId !== 'undefined' ? categoryId : '' %>" data-locale="<%= typeof locale !== 'undefined' ? locale : 'zh-CN' %>">
                        <% 
                            // Ê†ºÂºèÂåñÊèèËø∞ÊñáÊú¨ÔºåÂ∞ÜÊç¢Ë°åËΩ¨Êç¢‰∏∫ÊÆµËêΩ
                            const detailLines = game.detail.split('\n').filter(line => line.trim());
                            let inParagraph = false;
                            let skipNext = false;
                            
                            detailLines.forEach((line, index) => {
                                const trimmedLine = line.trim();
                                
                                // Ë∑≥Ëøá‰∏Ä‰∫õÂÖÉÊï∞ÊçÆË°åÂíåÂàÜÈöîÁ¨¶
                                if (trimmedLine.includes('Games¬ª') || 
                                    trimmedLine === 'Share' ||
                                    trimmedLine.includes('Developer') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Rating') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Released') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Technology') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Platform') && !trimmedLine.includes(':') ||
                                    trimmedLine.includes('Wiki pages') ||
                                    trimmedLine.match(/^[0-9]+$/) ||  // Á∫ØÊï∞Â≠ó
                                    trimmedLine.length < 5) {
                                    return;
                                }
                                
                                // Â¶ÇÊûúÊòØÊ†áÈ¢òË°åÔºàÁü≠‰∏îÂèØËÉΩÊòØÊ†áÈ¢òÔºå‰∏îÊ≤°ÊúâÊ†áÁÇπÁ¨¶Âè∑Ôºâ
                                if (trimmedLine.length < 60 && 
                                    !trimmedLine.includes('.') && 
                                    !trimmedLine.includes(',') &&
                                    !trimmedLine.includes('?') &&
                                    !trimmedLine.includes('!') &&
                                    trimmedLine.length > 10 &&
                                    index < 15) {
                                    if (inParagraph) {
                                        inParagraph = false;
                                        %>
                                        </p>
                                        <%
                                    }
                                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∏∏ËßÅÁöÑÊ†áÈ¢òÊ†ºÂºè
                                    if (trimmedLine.match(/^[A-Z][a-z]+ [A-Z][a-z]+/) || 
                                        trimmedLine.match(/^[A-Z][a-z]+ [a-z]+ [A-Z]/) ||
                                        trimmedLine.includes('How to') ||
                                        trimmedLine.includes('Features') ||
                                        trimmedLine.includes('Controls') ||
                                        trimmedLine.includes('FAQ')) {
                                        %>
                                        <h3 class="game-detail-subtitle"><%= trimmedLine %></h3>
                                        <%
                                    }
                                    return;
                                }
                                
                                // Â¶ÇÊûúÊòØÊÆµËêΩÂÜÖÂÆπÔºàÈïøÂ∫¶ÂêàÁêÜ‰∏îÊúâÊÑè‰πâÁöÑÊñáÊú¨Ôºâ
                                if (trimmedLine.length > 15) {
                                    // ËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶ÔºàÈô§‰∫ÜÊàë‰ª¨ÂÖÅËÆ∏ÁöÑÊ†ºÂºèÔºâ
                                    const escapedLine = trimmedLine
                                        .replace(/&/g, '&amp;')
                                        .replace(/</g, '&lt;')
                                        .replace(/>/g, '&gt;')
                                        .replace(/&lt;strong&gt;/g, '<strong>')
                                        .replace(/&lt;\/strong&gt;/g, '</strong>');
                                    
                                    if (!inParagraph) {
                                        inParagraph = true;
                                        %>
                                        <p>
                                        <%
                                    } else {
                                        %>
                                        <br><br>
                                        <%
                                    }
                                    %>
                                    <%- escapedLine %>
                                    <%
                                }
                            });
                            if (inParagraph) {
                                %>
                                </p>
                                <%
                            }
                        %>
                    </div>
                </div>
            <% } %>

            <!-- Ê∏∏ÊàèÁâπÊÄß -->
            <div class="game-features">
                <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.gameFeatures') : 'Ê∏∏ÊàèÁâπÊÄß' %></h2>
                <ul class="game-features-list">
                    <li>‚úÖ <%= typeof t !== 'undefined' ? t('game.features.free') : 'ÂÖçË¥πÂú®Á∫øÊ∏∏ÊàèÔºåÊó†ÈúÄ‰∏ãËΩΩ' %></li>
                    <li>‚úÖ <%= typeof t !== 'undefined' ? t('game.features.crossPlatform') : 'ÊîØÊåÅPCÂíåÁßªÂä®Á´Ø' %></li>
                    <li>‚úÖ <%= typeof t !== 'undefined' ? t('game.features.html5') : 'HTML5ÊäÄÊúØÔºåÂç≥ÂºÄÂç≥Áé©' %></li>
                    <% if (gameCategory) { %>
                        <li>‚úÖ <%= typeof t !== 'undefined' ? t('game.features.category', { category: gameCategory }) : ('Â±û‰∫é' + gameCategory + 'ÂàÜÁ±ª') %></li>
                    <% } %>
                </ul>
            </div>

            <!-- Áõ∏ÂÖ≥Ê∏∏ÊàèÊé®Ëçê -->
            <% if (gameCategory) { %>
                <div class="game-related">
                    <h2 class="game-detail-section-title"><%= typeof t !== 'undefined' ? t('game.relatedGames') : 'Áõ∏ÂÖ≥Ê∏∏ÊàèÊé®Ëçê' %></h2>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="<%= typeof localeUrl !== 'undefined' ? localeUrl('/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory)) : '/category/' + encodeURIComponent(typeof originalGameCategory !== 'undefined' ? originalGameCategory : gameCategory) %>" class="more-btn">
                            <%= typeof t !== 'undefined' ? t('game.viewAllInCategory', { category: gameCategory }) : ('Êü•Áúã ' + gameCategory + ' ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÊ∏∏Êàè ‚Üí') %>
                        </a>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // ÂÖ®Â±èÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function() {
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const gameContainer = document.getElementById('gameContainer');
        const gameIframe = document.getElementById('gameIframe');
        
        if (!fullscreenBtn || !gameContainer) return;
        
        const fullscreenText = '<%= typeof t !== "undefined" ? t("game.fullscreen") : "ÂÖ®Â±è" %>';
        const exitFullscreenText = '<%= typeof t !== "undefined" ? t("game.exitFullscreen") : "ÈÄÄÂá∫ÂÖ®Â±è" %>';
        
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // ËøõÂÖ•ÂÖ®Â±è
                if (gameContainer.requestFullscreen) {
                    gameContainer.requestFullscreen();
                } else if (gameContainer.webkitRequestFullscreen) {
                    gameContainer.webkitRequestFullscreen();
                } else if (gameContainer.mozRequestFullScreen) {
                    gameContainer.mozRequestFullScreen();
                } else if (gameContainer.msRequestFullscreen) {
                    gameContainer.msRequestFullscreen();
                }
            } else {
                // ÈÄÄÂá∫ÂÖ®Â±è
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // ÁõëÂê¨ÂÖ®Â±èÁä∂ÊÄÅÂèòÂåñ
        function handleFullscreenChange() {
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                fullscreenBtn.textContent = '‚ùå ' + exitFullscreenText;
                fullscreenBtn.classList.add('active');
            } else {
                fullscreenBtn.textContent = '‚õ∂ ' + fullscreenText;
                fullscreenBtn.classList.remove('active');
            }
        }
        
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆÔºöF11 ÂÖ®Â±èÔºåESC ÈÄÄÂá∫ÔºàÊµèËßàÂô®ÈªòËÆ§Â§ÑÁêÜÔºâ
    });
    
    // ÂºÇÊ≠•Âä†ËΩΩÁøªËØëÂêéÁöÑÊ∏∏Êàè‰ªãÁªç
    (function() {
        const detailTextEl = document.getElementById('game-detail-text');
        if (!detailTextEl) {
            console.log('[Client] game-detail-text element not found');
            return;
        }
        
        const gameId = detailTextEl.getAttribute('data-game-id');
        const categoryId = detailTextEl.getAttribute('data-category-id');
        const locale = detailTextEl.getAttribute('data-locale') || 'zh-CN';
        
        console.log('[Client] Translation loader initialized:', { gameId, categoryId, locale });
        
        if (!gameId || !categoryId) {
            console.log('[Client] Missing gameId or categoryId, skipping translation');
            return; // Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞
        }
        
        if (locale !== 'zh-CN') {
            console.log('[Client] Locale is not zh-CN, skipping translation');
            return; // ‰∏çÈúÄË¶ÅÁøªËØë
        }
        
        // ‰øùÂ≠òÂéüÂßãÂÜÖÂÆπ
        const originalContent = detailTextEl.innerHTML;
        
        // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
        const loadingIndicator = document.createElement('div');
        loadingIndicator.style.cssText = 'text-align: center; padding: 1rem; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;';
        loadingIndicator.innerHTML = 'Ê≠£Âú®ÁøªËØëÊ∏∏Êàè‰ªãÁªç...';
        detailTextEl.appendChild(loadingIndicator);
        
        // ÂºÇÊ≠•Âä†ËΩΩÁøªËØë
        function loadTranslation() {
            const apiUrl = `/api/game/translate?gameId=${encodeURIComponent(gameId)}&categoryId=${encodeURIComponent(categoryId)}&locale=${encodeURIComponent(locale)}`;
            console.log('[Client] Requesting translation from:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    console.log('[Client] Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[Client] Translation response:', { translated: data.translated, detailLength: data.detail ? data.detail.length : 0 });
                    if (data.translated && data.detail) {
                        // ÁßªÈô§Âä†ËΩΩÊèêÁ§∫
                        loadingIndicator.remove();
                        
                        // Ê†ºÂºèÂåñÂπ∂ÊõøÊç¢ÂÜÖÂÆπ
                        formatAndReplaceDetail(detailTextEl, data.detail);
                        
                        console.log('[Client] Translation loaded and replaced successfully');
                    } else {
                        // ÁøªËØëÂ§±Ë¥•ÊàñËøîÂõûÂéüÊñáÔºåÁßªÈô§Âä†ËΩΩÊèêÁ§∫
                        loadingIndicator.remove();
                        console.log('[Client] Translation not available, using original text. Response:', data);
                    }
                })
                .catch(err => {
                    console.error('[Client] Failed to load translation:', err);
                    loadingIndicator.remove();
                });
        }
        
        // Ê†ºÂºèÂåñÂπ∂ÊõøÊç¢Ê∏∏Êàè‰ªãÁªçÂÜÖÂÆπ
        function formatAndReplaceDetail(container, detailText) {
            const detailLines = detailText.split('\n').filter(line => line.trim());
            let html = '';
            let inParagraph = false;
            
            detailLines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // Ë∑≥Ëøá‰∏Ä‰∫õÂÖÉÊï∞ÊçÆË°åÂíåÂàÜÈöîÁ¨¶
                if (trimmedLine.includes('Games¬ª') || 
                    trimmedLine === 'Share' ||
                    trimmedLine.includes('Developer') && !trimmedLine.includes(':') ||
                    trimmedLine.includes('Rating') && !trimmedLine.includes(':') ||
                    trimmedLine.includes('Released') && !trimmedLine.includes(':') ||
                    trimmedLine.includes('Technology') && !trimmedLine.includes(':') ||
                    trimmedLine.includes('Platform') && !trimmedLine.includes(':') ||
                    trimmedLine.includes('Wiki pages') ||
                    trimmedLine.match(/^[0-9]+$/) ||
                    trimmedLine.length < 5) {
                    return;
                }
                
                // Â¶ÇÊûúÊòØÊ†áÈ¢òË°å
                if (trimmedLine.length < 60 && 
                    !trimmedLine.includes('.') && 
                    !trimmedLine.includes(',') &&
                    !trimmedLine.includes('?') &&
                    !trimmedLine.includes('!') &&
                    trimmedLine.length > 10 &&
                    index < 15) {
                    if (inParagraph) {
                        inParagraph = false;
                        html += '</p>';
                    }
                    if (trimmedLine.match(/^[A-Z][a-z]+ [A-Z][a-z]+/) || 
                        trimmedLine.match(/^[A-Z][a-z]+ [a-z]+ [A-Z]/) ||
                        trimmedLine.includes('How to') ||
                        trimmedLine.includes('Features') ||
                        trimmedLine.includes('Controls') ||
                        trimmedLine.includes('FAQ')) {
                        html += `<h3 class="game-detail-subtitle">${escapeHtml(trimmedLine)}</h3>`;
                    }
                    return;
                }
                
                // Â¶ÇÊûúÊòØÊÆµËêΩÂÜÖÂÆπ
                if (trimmedLine.length > 15) {
                    const escapedLine = escapeHtml(trimmedLine)
                        .replace(/&lt;strong&gt;/g, '<strong>')
                        .replace(/&lt;\/strong&gt;/g, '</strong>');
                    
                    if (!inParagraph) {
                        inParagraph = true;
                        html += '<p>';
                    } else {
                        html += '<br><br>';
                    }
                    html += escapedLine;
                }
            });
            
            if (inParagraph) {
                html += '</p>';
            }
            
            container.innerHTML = html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }
        
        // Âª∂ËøüÂä†ËΩΩÔºåËÆ©È°µÈù¢ÂÖàÊ∏≤Êüì
        setTimeout(loadTranslation, 500);
    })();
</script>

<%- include('partials/footer') %>
